<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理系统 | 持久化版本</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 保持所有CSS樣式不變，這裡為了節省篇幅省略 */
        /* 請使用之前提供的完整CSS樣式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --sidebar-width: 250px;
            --header-height: 70px;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
        }

        .login-box {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            padding: 40px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: var(--primary-color);
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--gray-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background-color: #3251d4;
        }

        .login-footer {
            text-align: center;
            margin-top: 25px;
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .storage-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--primary-color);
        }

        .storage-info h4 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .mobile-menu-toggle {
                display: block !important;
            }
        }

        @media (min-width: 993px) {
            .mobile-menu-toggle {
                display: none !important;
            }
        }

        .mobile-menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 5px;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }

        /* ... 其他CSS樣式保持不變 ... */
    </style>
</head>
<body>
    <!-- 登錄頁面 -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1><i class="fas fa-cloud-upload-alt"></i> 文件管理系统</h1>
                <p>修正版 - 數據持久化</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">用戶名</label>
                    <input type="text" id="username" class="form-control" placeholder="請輸入用戶名" required>
                </div>
                <div class="form-group">
                    <label for="password">密碼</label>
                    <input type="password" id="password" class="form-control" placeholder="請輸入密碼" required>
                </div>
                <button type="submit" class="login-btn">登錄</button>
            </form>
            
            <div class="storage-info">
                <h4><i class="fas fa-database"></i> 數據存儲信息</h4>
                <p>此版本已修正數據持久化問題</p>
                <div class="progress-bar">
                    <div class="progress" id="storage-progress" style="width: 0%"></div>
                </div>
                <p id="storage-text">正在計算存儲使用情況...</p>
            </div>
            
            <div class="login-footer">
                <p>演示賬號: admin / password123 或 user1 / password123</p>
                <p><button id="reset-data-btn" style="background: none; border: none; color: var(--danger-color); cursor: pointer; text-decoration: underline;">重置所有數據</button></p>
            </div>
        </div>
    </div>

    <!-- 主應用頁面（結構保持不變） -->
    <div id="app-page" class="container" style="display: none;">
        <!-- 側邊欄和主內容結構與之前相同 -->
        <!-- 這裡為了節省篇幅省略，使用之前的完整結構 -->
    </div>

    <!-- 模態框等結構保持不變 -->

    <script>
        // ============================
        // 修正版數據管理模塊
        // ============================
        
        const STORAGE_KEY = 'fileManagerData_fixed'; // 使用新的鍵名
        const MAX_STORAGE_SIZE = 5 * 1024 * 1024;
        
        // 默認數據 - 簡化版本，不包含演示文件
        const defaultData = {
            users: [
                { 
                    id: 1, 
                    username: 'admin', 
                    fullname: '系統管理員', 
                    email: 'admin@example.com', 
                    role: 'admin', 
                    createdAt: new Date().toISOString().split('T')[0], 
                    status: 'active', 
                    password: 'password123' 
                },
                { 
                    id: 2, 
                    username: 'user1', 
                    fullname: '普通用戶', 
                    email: 'user1@example.com', 
                    role: 'user', 
                    createdAt: new Date().toISOString().split('T')[0], 
                    status: 'active', 
                    password: 'password123' 
                }
            ],
            files: [], // 空數組，無演示文件
            logs: [],
            settings: {
                maxFileSize: 100,
                allowedTypes: ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'jpg', 'jpeg', 'png', 'gif', 'zip', 'rar'],
                initialized: false
            }
        };
        
        let currentData = null;
        let currentUser = null;
        
        // 修正的數據加載函數
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                
                if (savedData) {
                    // 有保存的數據，直接使用
                    currentData = JSON.parse(savedData);
                    console.log('從LocalStorage加載數據成功');
                } else {
                    // 首次使用，創建新數據
                    console.log('首次使用，創建新數據');
                    currentData = JSON.parse(JSON.stringify(defaultData));
                    currentData.logs.push({
                        id: 1,
                        time: new Date().toLocaleString('zh-CN'),
                        user: 'system',
                        action: '系統初始化',
                        details: '創建新的數據庫',
                        ip: 'local'
                    });
                    currentData.settings.initialized = true;
                    saveDataToLocalStorage();
                }
                
                // 確保數據結構完整
                ensureDataIntegrity();
                updateStorageInfo();
                return true;
            } catch (error) {
                console.error('加載數據失敗:', error);
                // 創建乾淨的數據
                currentData = JSON.parse(JSON.stringify(defaultData));
                currentData.settings.initialized = true;
                saveDataToLocalStorage();
                return false;
            }
        }
        
        // 確保數據完整性
        function ensureDataIntegrity() {
            if (!currentData.users) currentData.users = defaultData.users;
            if (!currentData.files) currentData.files = [];
            if (!currentData.logs) currentData.logs = [];
            if (!currentData.settings) currentData.settings = defaultData.settings;
            
            // 確保有管理員賬戶
            const hasAdmin = currentData.users.some(u => u.username === 'admin');
            if (!hasAdmin) {
                currentData.users.push({
                    ...defaultData.users[0],
                    id: currentData.users.length + 1
                });
            }
            
            // 確保文件有正確的ID
            currentData.files.forEach((file, index) => {
                if (!file.id) file.id = index + 1;
                if (!file.uploadedAt) file.uploadedAt = new Date().toLocaleString('zh-CN');
            });
        }
        
        // 保存數據
        function saveDataToLocalStorage() {
            if (!currentData) return false;
            
            try {
                ensureDataIntegrity();
                const dataStr = JSON.stringify(currentData);
                localStorage.setItem(STORAGE_KEY, dataStr);
                updateStorageInfo();
                console.log('數據保存成功');
                return true;
            } catch (error) {
                console.error('保存數據失敗:', error);
                return false;
            }
        }
        
        // 清除舊數據（解決之前版本的問題）
        function clearOldData() {
            const oldKeys = ['fileManagerData_v1', 'fileManagerData_v2', 'fileManagerData'];
            oldKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    console.log(`已清除舊數據: ${key}`);
                }
            });
        }
        
        // 更新存儲信息
        function updateStorageInfo() {
            try {
                if (!currentData) return;
                
                const dataStr = JSON.stringify(currentData);
                const usedSize = new Blob([dataStr]).size;
                const usedKB = (usedSize / 1024).toFixed(2);
                const usedPercent = Math.min((usedSize / MAX_STORAGE_SIZE * 100), 100).toFixed(1);
                
                const progressBar = document.getElementById('storage-progress');
                const storageText = document.getElementById('storage-text');
                
                if (progressBar && storageText) {
                    progressBar.style.width = `${usedPercent}%`;
                    storageText.textContent = `已使用 ${usedKB} KB (${usedPercent}%)`;
                    
                    if (usedPercent > 80) {
                        progressBar.style.backgroundColor = 'var(--danger-color)';
                    } else if (usedPercent > 60) {
                        progressBar.style.backgroundColor = 'var(--warning-color)';
                    } else {
                        progressBar.style.backgroundColor = 'var(--primary-color)';
                    }
                }
            } catch (error) {
                console.error('更新存儲信息失敗:', error);
            }
        }
        
        // 初始化系統
        document.addEventListener('DOMContentLoaded', function() {
            // 清除舊版本的數據
            clearOldData();
            
            // 加載數據
            loadDataFromLocalStorage();
            
            // 登錄表單提交
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // 驗證用戶
                const user = currentData.users.find(u => 
                    u.username === username && 
                    u.password === password && 
                    u.status === 'active'
                );
                
                if (user) {
                    currentUser = { ...user };
                    delete currentUser.password; // 移除密碼
                    
                    // 記錄日誌
                    currentData.logs.unshift({
                        id: currentData.logs.length + 1,
                        time: new Date().toLocaleString('zh-CN'),
                        user: currentUser.username,
                        action: '登錄系統',
                        details: '用戶登錄成功',
                        ip: 'local'
                    });
                    saveDataToLocalStorage();
                    
                    // 切換到主界面
                    document.getElementById('login-page').style.display = 'none';
                    document.getElementById('app-page').style.display = 'flex';
                    
                    // 初始化主應用
                    initializeMainApp();
                } else {
                    alert('用戶名或密碼錯誤！');
                }
            });
            
            // 重置數據按鈕
            document.getElementById('reset-data-btn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('確定要重置所有數據嗎？這將清除所有文件、用戶和日誌！')) {
                    localStorage.removeItem(STORAGE_KEY);
                    alert('數據已重置，頁面將刷新...');
                    location.reload();
                }
            });
            
            updateStorageInfo();
        });
        
        // 主應用初始化函數
        function initializeMainApp() {
            // 這裡添加主應用的初始化代碼
            // 由於篇幅限制，這裡只顯示關鍵部分
            
            console.log('主應用初始化，當前用戶:', currentUser.username);
            
            // 更新用戶界面
            if (document.getElementById('user-name')) {
                document.getElementById('user-name').textContent = currentUser.fullname;
                document.getElementById('user-role').textContent = 
                    currentUser.role === 'admin' ? '系統管理員' : '普通用戶';
            }
            
            // 登出功能
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    // 記錄日誌
                    currentData.logs.unshift({
                        id: currentData.logs.length + 1,
                        time: new Date().toLocaleString('zh-CN'),
                        user: currentUser.username,
                        action: '退出系統',
                        details: '用戶安全退出',
                        ip: 'local'
                    });
                    saveDataToLocalStorage();
                    
                    currentUser = null;
                    document.getElementById('app-page').style.display = 'none';
                    document.getElementById('login-page').style.display = 'flex';
                });
            }
            
            // 顯示當前文件數量
            updateFileCount();
        }
        
        // 更新文件數量顯示
        function updateFileCount() {
            const fileCount = currentData.files.length;
            console.log('當前文件數量:', fileCount);
        }
        
        // 自動保存
        setInterval(() => {
            if (currentUser) {
                saveDataToLocalStorage();
            }
        }, 30000);
        
        // 頁面關閉前保存
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                saveDataToLocalStorage();
            }
        });
    </script>
</body>
</html>
